{% extends 'shop/basic.html' %}
{% load static %}
{% load splitTag %}
{%block home%}active{%endblock home%}
{% block title %} {{product.product_name}} - buyCart {% endblock %}
{% block css %}
<style>
  .description {
    background: linear-gradient(90deg, #F3C4FB 0%, #A5F3FC 45%, #D1E8FF 100%);
    border-radius: 20px;
    border: 3px solid blue;
    display: flex;
    flex-direction: column;

  }

  .descIn {
    max-height: 300px;
    overflow-y: auto;
  }

  .divpr {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 250px;
    height: 50px;
  }

  .star-rating::after {
    content: "⭐⭐⭐⭐⭐";
    --rating-percent: calc(attr(data-rating type(<number>), 0) / 5 * 100%);
    background: linear-gradient(90deg, gold var(--rating-percent), grey var(--rating-percent));
    color: transparent;
    background-clip: text;
  }

  #review {
    border: 2px solid black;
    outline: none;
    border-radius: 5px;
    padding: 5px 5px !important;
  }

  #review:focus {
    outline: none;
    border: 2px solid blue;
  }

  select {
    text-align: center;
    text-align-last: center;
  }

  .carousel-control-prev-icon,
  .carousel-control-next-icon {
    background-image: none;
    width: 40px;
    height: 40px;
    background-color: black;
    border-radius: 50%;
    position: relative;
  }


  .carousel-control-prev-icon::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 12px;
    height: 12px;
    border-left: 3px solid white;
    border-bottom: 3px solid white;
    transform: translate(-40%, -50%) rotate(45deg);
  }


  .carousel-control-next-icon::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 12px;
    height: 12px;
    border-right: 3px solid white;
    border-top: 3px solid white;
    transform: translate(-60%, -50%) rotate(45deg);
  }

  .carousel-indicators button {
    background-color: black !important;
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .carousel-indicators .active {
    background-color: black !important;
  }

  .carousel-control-prev,
  .carousel-control-next {
    opacity: 0.6;
  }

  .carousel-control-prev:hover,
  .carousel-control-next:hover {
    opacity: 1;
  }
</style>
{% endblock css %}
{% block body %}
<div class="container text-secondary-emphasis my-4" style="margin-top: 70px!important;">
  <div class="row">
    <div class="col-md-4">
      <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">

        <div class="carousel-indicators">
          <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="0" class="active"></button>

          {% for img in product.extra_images.all %}
          <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter }}"></button>
          {% endfor %}
        </div>

        <div class="carousel-inner" style="margin-top: 50px;">

          <div class="carousel-item active">
            <img src="{{ product.main_image.url }}" class="d-block w-100" style="height:380px; object-fit:contain;">
          </div>

          {% for img in product.extra_images.all %}
          <div class="carousel-item">
            <img src="{{ img.image.url }}" class="d-block w-100" style="height:380px; object-fit:contain;">
          </div>
          {% endfor %}
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>

      </div>

      <div class="row my-1">

      </div>
    </div>

    <div class="col-md-8 my-4 description py-4 px-4">
      <h4><b id="namepr{{product.id}}">{{product.product_name}}</b></h4>
      {% if product.discount == 0 %}
      <p><b style="font-size: 20px;" id="pricepr{{product.id}}"
          class="text-success">{{product.finalPrice}}</b><b>&nbsp;₹</b>
        {% if product.prodRating %}
        <span class="badge bg-warning text-dark fs-6 mx-4" style="width:fit-content;"> ⭐ {{ product.prodRating}}/5</span>
        {% endif %}
      </p>
      {% else %}
      <p><b style="font-size: 20px;"
          class="text-danger text-decoration-line-through">{{product.price}}</b><b>&nbsp;₹</b> (-{{product.discount}} %)
        {% if product.prodRating %}
        <span class="badge bg-warning text-dark fs-6 mx-4" style="width:fit-content;"> ⭐ {{ product.prodRating}}/5</span>
        {% endif %}
      </p>
      <p><b style="font-size: 20px;" id="pricepr{{product.id}}"
          class="text-success">{{product.finalPrice}}</b><b>&nbsp;₹</b></p>
      {% endif %}
      <div class="descIn">
        <p>{{product.desc|safe}}</p>
      </div>
      {% if product.available_sizes %}
      <div class="mt-2 mb-3">
        <p class="fw-semibold mb-2">Available Sizes</p>

        <div class="d-flex flex-wrap gap-2">
          {% for size in product.available_sizes|cut:" "|split:"," %}
          {% if forloop.first%}
          <input type="radio" class="btn-check" name="selected_size{{product.id}}" id="size{{ forloop.counter }}" value="{{ size }}" autocomplete="off" checked>
          {% else %}
          <input type="radio" class="btn-check" name="selected_size{{product.id}}" id="size{{ forloop.counter }}" value="{{ size }}" autocomplete="off" >
          {% endif %}
          <label class="btn btn-outline-primary rounded-pill px-3 py-1" for="size{{ forloop.counter }}">
            {{ size }}
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div style="display: flex; flex-direction: row; justify-content: center;" class="mt-auto">
        {% if request.user.is_authenticated %}
        <a class="divpr" href='/shop/checkout/?dummy=true' style="text-decoration: none;">
          <button class="btn btn-primary mx-2" type="submit" id="buyNow" style="width: 100%; height:100%;">Buy
            Now</button>
        </a>
        {% else %}
        <button type="button" class="btn btn-primary mx-2 divpr" data-toggle="modal" data-target="#loginModal">
          Buy Now
        </button>
        {% endif %}

        {% if request.user.is_authenticated %}
        <div id="divpr{{product.id}}" class="divpr">
          <button id="pr{{product.id}}" class="btn btn-primary cart mx-2" style="width: 100%;height:100%;">Add To
            Cart</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>


</div>
<hr class="w-75" style="align-items: center; margin: auto;">

<div class="container my-4 d-flex justify-content-center flex-column align-items-center">
  <h4>Rating <span class="star-rating" data-rating="{{product.prodRating}}" style="font-size: 40px;"></span> <span
      class="text-muted fs-6">(rated by : {{product.ratingCount}} customers)</span></h4>


  <form class="row g-3" action="/shop/rating/" method="post">
    {% csrf_token %}
    <div class="d-flex flex-column ">
      <input type="hidden" value="{{product.id}}" name="prodId">
      <label for="review" class="form-label">Review</label>
      <textarea name="review" id="review" rows="5" placeholder="Enter Your Review Here..." required></textarea>
    </div>
    <div class="col-12 d-flex flex-column ">
      <label for="rate" class="form-label">Rate</label>
      <select name="rate" id="rate" class="form-select d-flex justify-content-center" required>
        <option value="0" disabled selected>Give Rate</option>
        <option value="1">worst</option>
        <option value="2">Poor</option>
        <option value="3">Good</option>
        <option value="4">Very Good</option>
        <option value="5">Excelent</option>
      </select>
    </div>
    <div class="col-12 d-flex justify-content-center">
      <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Submit</button>
    </div>

  </form>



</div>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-7">
      <h4 class="mt-4 text-center mb-4">Reviews</h4>
      <div class="card mb-3 shadow-sm">
        {% for r in product.rating_set.all %}
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold text-primary">
              {{ r.user.username }}
            </h6>
            <span class="badge bg-warning text-dark fs-6">
              ⭐ {{ r.rating }}/5
            </span>
          </div>

          <p class="mt-2 mb-2 text-secondary">
            {{ r.review }}
          </p>

          <small class="text-muted">
            Reviewed on {{ r.created_at|date:"d M Y, h:i A" }}
          </small>

        </div>
        {% empty %}
        <p class="text-muted text-center">No reviews yet.</p>
        {% endfor %}

      </div>
    </div>
  </div>
</div>



{% endblock %}

{% block js %}
<script src="{% static 'shop/js/cart.js' %}"></script>
<script>
  
  let id = "pr{{ product.id }}";
  function updateCart(cart) {
    const divEl = document.getElementById('div' + id);
    if (divEl) {
      if (cart[id] && cart[id][0] > 0) {
        divEl.innerHTML =
          "<button id='minus" + id + "' class='btn btn-primary minus' style='height: 50px;width:50px;'>-</button> " +
          "<span id='val" + id + "' class='mx-4'>" + cart[id][0] + "</span> " +
          "<button id='plus" + id + "' class='btn btn-primary plus' style='height: 50px;width:50px;'> + </button>";
      } else {
        divEl.innerHTML =
          "<button id='" + id + "' class='btn btn-primary cart mx-2' style='width: 100%;height:100%;'>Add To Cart</button>";
        if (cart[id]) {
          delete cart[id];
        }
      }
    }

    let sum = 0;
    for (let item in cart) {
      sum += cart[item][0];
    }

    localStorage.setItem(cartKey, btoa(JSON.stringify(cart)));

    const cartBadge = document.getElementById('cart');
    if (cartBadge) {
      cartBadge.innerHTML = sum;
    }

    updatePopover(cart);
  }


  btn = document.getElementById('buyNow')
  btn.addEventListener("click", function () {
    let cartDummy = cartKey + "Dummy";
    const selected = document.querySelector('input[name="selected_size{{product.id}}"]:checked');
    let cart2 = {}
    if (cart[id] === undefined) {
      cart2[id] = [1, "{{product.product_name}}", parseFloat("{{product.finalPrice}}"),selected.value];
    }
    else {
      cart2[id] = cart[id];
      console.log(cartDummy);
      delete cart[id]
      localStorage.setItem(cartKey, btoa(JSON.stringify(cart)));
    }
    localStorage.setItem(cartDummy, btoa(JSON.stringify(cart2)));
  })

  const rateSelect = document.getElementById('rate');
  const submitBtn = document.getElementById('submitBtn');

  rateSelect.addEventListener('change', function () {
    if (this.value === "0") {
      submitBtn.disabled = true;
    } else {
      submitBtn.disabled = false;
    }
  });


</script>


{% endblock %}